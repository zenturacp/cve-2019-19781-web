<?php

function updateCounter($file) {
    if (file_exists($file)) {
        $counter = intval(file_get_contents($file));
        $counter += 1;    
    } else {
        $counter = 1;
    }
    file_put_contents($file, $counter);
    return $counter;
}

$salt = $_ENV["SALT"];
$database = json_decode(file_get_contents("database.json"));

$inputDomain = strtolower(htmlspecialchars($_POST["inputDomain"]));
if ($inputDomain != "") {
    $inputDomain = "*." . $inputDomain;
    $inputHash = hash("sha256", $inputDomain . $salt);
} else {
    $validDomainName = false;
}
$outputString = "";

if (in_array($inputHash, $database)) {
    $outputString = "<p style=color:red>CRITICAL: " . $inputDomain . " was leaked and you are now exposed to phishing attempts until you renew your certificate<br>Remember to revoke the old certificate</p>";
    $outputString .= "<p>This will keep stating that you are critical even after you revoke the certificate because this is checked against an offline database with " . count($database) . " domains</p>";
} else {
    $outputString = "Probably good news: There is no match on " . $inputDomain . ", but there its not certain that you are safe";
    $outputString .= "<p>Even because you are not on the list there this is NO guarantee that your certificate is not leaked - this is just a database with " . count($database) . " domains listed</p>";
}

?>

<!doctype html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>Scan Result</title>
</head>

<body>
    <div class=container>

    <?php
    if ($validDomainName === false) {
        echo "<h1>Error</h1>";
        echo "<p>Invalid or missing domain name</p>";
    } else {
        echo "<h1>Looking up: $inputDomain</h1>";
        echo $outputString;
    }
    ?>
    <p>
    <a href=/><button type="button" class="btn btn-primary">Back to start</button></a>
    <p>
        Counter since January 28. 2020: <?php echo updateCounter("/var/www/counter/WildCard.txt"); ?>
    </p>
    </div>

</body>

</html>
